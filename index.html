<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 图片生成/多模态助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --apple-blue: #007AFF;
            --apple-gray: #F5F5F7;
            --apple-text: #1D1D1F;
            --apple-border: #D2D2D7;
        }
        body {
            background-color: #F5F5F7;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            color: var(--apple-text);
            -webkit-font-smoothing: antialiased;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .apple-input {
            background-color: rgba(118, 118, 128, 0.12);
            border: none;
            transition: all 0.2s ease;
        }
        .apple-input:focus {
            background-color: rgba(118, 118, 128, 0.08);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15);
            outline: none;
        }
        .apple-btn {
            background-color: var(--apple-blue);
            transition: all 0.2s ease;
        }
        .apple-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        .apple-btn:active {
            transform: scale(0.98);
        }
        .markdown-body img {
            max-width: 100%;
            max-height: 60vh;
            width: auto;
            display: block;
            margin: 16px auto;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .markdown-body pre {
            background-color: #F5F5F7;
            padding: 16px;
            border-radius: 12px;
            overflow: auto;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .loader {
            border: 3px solid rgba(0, 122, 255, 0.1);
            border-top: 3px solid var(--apple-blue);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-8px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes skeleton-pulse {
            0% { background-color: rgba(0, 0, 0, 0.05); }
            50% { background-color: rgba(0, 0, 0, 0.12); }
            100% { background-color: rgba(0, 0, 0, 0.05); }
        }
        .skeleton {
            animation: skeleton-pulse 1.5s ease-in-out infinite;
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen py-6 px-4 sm:px-6 lg:px-8 flex justify-center items-center">
        <div class="w-full max-w-7xl bg-white rounded-3xl shadow-2xl overflow-hidden border border-white/50 relative">
            <div class="p-6 sm:p-8">
                <div class="mb-6 flex items-center justify-between">
                    <div>
                        <div class="uppercase tracking-wider text-xs text-gray-500 font-bold mb-1"> Creative Studio</div>
                        <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Banana创作助手</h1>
                    </div>
                    <div class="flex items-center gap-3">
                        <!-- Mobile Config Toggle -->
                        <button @click="isConfigOpen = !isConfigOpen" class="lg:hidden p-2 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </button>
                        <div class="hidden sm:block">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-600">
                                Preview
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
                    <!-- 左侧功能区 -->
                    <div class="lg:col-span-5 space-y-4" :class="{'hidden lg:block': !isConfigOpen}">
                        <!-- 配置区域 -->
                        <div class="bg-gray-50/50 p-4 rounded-2xl border border-gray-100">
                            <h2 class="text-gray-900 text-sm font-semibold mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                参数设置
                            </h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-gray-500 text-xs font-medium mb-1 ml-1" for="api-key">API Key</label>
                                    <div class="flex gap-2">
                                        <input v-model="apiKey" class="apple-input rounded-xl w-full py-2 px-3 text-gray-800 text-sm placeholder-gray-400" id="api-key" type="password" placeholder="请输入您的 API Key">
                                        <button @click="saveApiKey" class="apple-btn text-white rounded-xl px-4 py-2 text-xs font-medium whitespace-nowrap shadow-sm hover:shadow-md transition-all min-w-[60px]">
                                            {{ saveButtonText }}
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-500 text-xs font-medium mb-1 ml-1">模型选择</label>
                                    <div class="relative">
                                        <!-- Custom Select Button -->
                                        <button @click="toggleModelDropdown" class="apple-input rounded-xl w-full py-2 px-3 text-left text-gray-800 text-sm flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all relative z-50 bg-white/50">
                                            <span class="break-all font-medium pr-2">{{ selectedModel }}</span>
                                            <svg class="h-4 w-4 text-gray-400 transition-transform duration-300" :class="{'rotate-180': isModelDropdownOpen}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </button>

                                        <!-- Dropdown Menu -->
                                        <div v-if="isModelDropdownOpen" class="absolute z-[60] mt-2 w-full bg-white/80 backdrop-blur-xl rounded-xl shadow-xl border border-white/60 overflow-hidden origin-top animate-fade-in-down ring-1 ring-black/5">
                                            <div class="p-1 max-h-60 overflow-auto custom-scrollbar">
                                                <div v-for="model in models" :key="model.value" 
                                                     @click="selectModel(model.value)"
                                                     class="px-3 py-2 rounded-lg text-sm cursor-pointer transition-all flex items-center justify-between group"
                                                     :class="{'bg-blue-500 text-white shadow-md shadow-blue-500/20': selectedModel === model.value, 'hover:bg-gray-100 text-gray-700': selectedModel !== model.value}">
                                                    <span class="font-medium break-all pr-2">{{ model.label }}</span>
                                                    <svg v-if="selectedModel === model.value" class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Backdrop for closing -->
                                        <div v-if="isModelDropdownOpen" @click="isModelDropdownOpen = false" class="fixed inset-0 z-40 cursor-default bg-transparent"></div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-500 text-xs font-medium mb-1 ml-1">历史保留 (张)</label>
                                    <input v-model.number="maxHistorySize" @change="saveHistory" type="number" min="1" max="50" class="apple-input rounded-xl w-full py-2 px-3 text-gray-800 text-sm placeholder-gray-400">
                                </div>
                            </div>
                        </div>

                        <!-- 输入区域 -->
                        <div>
                            <div class="mb-3">
                                <label class="block text-gray-500 text-xs font-medium mb-1 ml-1" for="prompt">提示词 (Prompt)</label>
                                <div class="relative">
                                    <div class="absolute top-0 left-0 right-0 px-4 py-2 bg-gray-100/50 rounded-t-2xl border-b border-gray-100 text-xs text-gray-500 font-medium flex items-center select-none">
                                        <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                        固定前缀：帮我生成一张图片：
                                    </div>
                                    <textarea v-model="prompt" class="apple-input rounded-2xl w-full pb-3 pt-10 px-4 text-gray-800 text-sm h-32 resize-none" id="prompt" placeholder="描述你想要生成的图片内容..."></textarea>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-500 text-xs font-medium mb-1 ml-1">参考图片 (可选)</label>
                                
                                <!-- Image Grid -->
                                <div v-if="images.length > 0" class="grid grid-cols-3 gap-2 mb-2">
                                    <div v-for="(img, index) in images" :key="index" class="relative aspect-square group">
                                        <img :src="img" class="w-full h-full object-cover rounded-lg shadow-sm border border-gray-200">
                                        <button @click.prevent="removeImage(index)" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition-all transform hover:scale-110">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                    <!-- Add Button (Small) -->
                                    <label for="dropzone-file-add" class="flex flex-col items-center justify-center aspect-square border-2 border-dashed border-gray-200 rounded-lg cursor-pointer bg-gray-50/50 hover:bg-gray-50 hover:border-blue-400 transition-all">
                                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                        <input id="dropzone-file-add" type="file" class="hidden" accept="image/*" multiple @change="handleImageUpload" />
                                    </label>
                                </div>

                                <!-- Empty State Dropzone -->
                                <div v-else class="flex items-center justify-center w-full">
                                    <label for="dropzone-file" class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-gray-200 rounded-2xl cursor-pointer bg-gray-50/50 hover:bg-gray-50 hover:border-blue-400 transition-all duration-300">
                                        <div class="flex flex-col items-center justify-center pt-3 pb-4">
                                            <div class="w-8 h-8 mb-2 rounded-full bg-blue-50 flex items-center justify-center text-blue-500">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                            </div>
                                            <p class="mb-0.5 text-xs text-gray-600 font-medium">点击上传或拖拽图片 (支持多张)</p>
                                        </div>
                                        <input id="dropzone-file" type="file" class="hidden" accept="image/*" multiple @change="handleImageUpload" />
                                    </label>
                                </div>
                            </div>

                            <button @click="generate" :disabled="loading || !prompt" :class="{'opacity-50 cursor-not-allowed': loading || !prompt}" class="apple-btn w-full text-white font-semibold py-3 px-6 rounded-2xl shadow-lg shadow-blue-500/30 flex justify-center items-center text-sm tracking-wide">
                                <span v-if="loading" class="loader mr-3 border-white/30 border-t-white"></span>
                                <span v-if="loading">正在生成...</span>
                                <span v-else class="flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                    开始生成
                                </span>
                            </button>
                        </div>

                        <!-- 提示词灵感区 -->
                        <div class="bg-gray-50/50 p-4 rounded-2xl border border-gray-100">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-gray-900 text-sm font-semibold flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                    提示词灵感
                                </h2>
                                <div class="flex bg-gray-200/50 rounded-lg p-0.5">
                                    <button @click="promptFilter = 'all'" :class="{'bg-white shadow-sm text-gray-800': promptFilter === 'all', 'text-gray-500 hover:text-gray-700': promptFilter !== 'all'}" class="px-2 py-1 text-[10px] font-medium rounded-md transition-all">全部</button>
                                    <button @click="promptFilter = 'generate'" :class="{'bg-white shadow-sm text-green-600': promptFilter === 'generate', 'text-gray-500 hover:text-gray-700': promptFilter !== 'generate'}" class="px-2 py-1 text-[10px] font-medium rounded-md transition-all">生图</button>
                                    <button @click="promptFilter = 'edit'" :class="{'bg-white shadow-sm text-blue-600': promptFilter === 'edit', 'text-gray-500 hover:text-gray-700': promptFilter !== 'edit'}" class="px-2 py-1 text-[10px] font-medium rounded-md transition-all">编辑</button>
                                </div>
                            </div>
                            
                            <div class="relative mb-3">
                                <input v-model="promptSearch" class="apple-input rounded-xl w-full py-2 pl-8 pr-3 text-gray-800 text-xs placeholder-gray-400" placeholder="搜索提示词...">
                                <svg class="w-3.5 h-3.5 text-gray-400 absolute left-2.5 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>

                            <div class="grid grid-cols-2 gap-3 max-h-[320px] overflow-y-auto custom-scrollbar pr-1">
                                <div v-if="prompts.length === 0 && !promptsLoading" class="col-span-2 text-center py-8 text-gray-400 text-xs">
                                    无法加载提示词库<br>请确保 prompts.json 存在
                                </div>
                                <div v-else-if="promptsLoading" class="col-span-2 text-center py-8 text-gray-400 text-xs">
                                    <span class="loader w-4 h-4 border-2 mr-2"></span>加载中...
                                </div>
                                <div v-else v-for="(item, index) in filteredPrompts" :key="index" @click="applyPrompt(item)" class="group relative bg-white rounded-xl border border-gray-200 overflow-hidden cursor-pointer hover:shadow-md transition-all hover:border-blue-300">
                                    <div class="aspect-video bg-gray-100 relative overflow-hidden">
                                        <img :src="item.preview" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy">
                                        <div class="absolute top-1 right-1">
                                            <span v-if="item.mode === 'generate'" class="bg-green-500/90 text-white text-[9px] px-1.5 py-0.5 rounded-full backdrop-blur-sm">生图</span>
                                            <span v-else class="bg-blue-500/90 text-white text-[9px] px-1.5 py-0.5 rounded-full backdrop-blur-sm">编辑</span>
                                        </div>
                                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                                            <span class="opacity-0 group-hover:opacity-100 bg-white/90 text-gray-800 text-[10px] font-bold px-2 py-1 rounded-full shadow-sm transform translate-y-2 group-hover:translate-y-0 transition-all">点击使用</span>
                                        </div>
                                    </div>
                                    <div class="p-2">
                                        <div class="text-xs font-medium text-gray-800 truncate">{{ item.title }}</div>
                                        <div class="text-[10px] text-gray-400 truncate mt-0.5">{{ item.author }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧结果区 -->
                    <div class="lg:col-span-7 flex flex-col min-h-[400px]">
                        <div class="bg-gray-50/50 rounded-3xl border border-gray-100 flex-grow flex flex-col overflow-hidden relative shadow-inner max-h-[85vh]">
                            <div class="bg-white/50 backdrop-blur-md px-6 py-4 border-b border-gray-100 flex justify-between items-center sticky top-0 z-10">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-green-400 mr-2"></span>
                                    生成结果
                                </h3>
                            </div>
                            
                            <div class="p-8 overflow-y-auto flex-grow custom-scrollbar">
                                <div v-if="loading" class="space-y-6 animate-fade-in-down">
                                    <div class="skeleton w-full aspect-video rounded-2xl"></div>
                                    <div class="space-y-3">
                                        <div class="skeleton h-4 w-3/4"></div>
                                        <div class="skeleton h-4 w-1/2"></div>
                                    </div>
                                </div>

                                <div v-else-if="error" class="bg-red-50/80 backdrop-blur border border-red-100 text-red-600 p-4 rounded-2xl shadow-sm" role="alert">
                                    <div class="flex items-center mb-2">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <p class="font-semibold">发生错误</p>
                                    </div>
                                    <p class="text-sm opacity-90 ml-7">{{ error }}</p>
                                </div>

                                <div v-else-if="result" class="space-y-4">
                                    <!-- Only show image if present -->
                                    <div v-if="extractImage(result)" class="flex justify-center">
                                         <img :src="extractImage(result)" @click="openLightbox(extractImage(result))" class="max-w-full rounded-xl shadow-lg cursor-zoom-in hover:opacity-95 transition-opacity" style="max-height: 60vh; width: auto;" />
                                    </div>
                                    <!-- If no image, show text (fallback for errors/refusals) -->
                                    <div v-else class="markdown-body prose prose-slate max-w-none" v-html="parsedResult"></div>

                                    <!-- Current Result Download -->
                                    <div v-if="extractImage(result)" class="flex justify-center">
                                        <button @click="downloadImage(extractImage(result))" class="apple-btn text-white rounded-xl px-6 py-2 text-sm font-medium shadow-lg hover:shadow-xl transition-all flex items-center">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                            下载图片
                                        </button>
                                    </div>
                                </div>
                                
                                <div v-else class="h-full flex flex-col items-center justify-center text-gray-300">
                                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-6">
                                        <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                    </div>
                                    <p class="text-sm font-medium">结果将在这里显示</p>
                                    <p class="text-xs mt-2 opacity-60">输入提示词并点击生成</p>
                                </div>
                            </div>
                        </div>

                        <!-- History Section (Separated) -->
                        <div v-if="history.length > 0" class="mt-6 bg-gray-50/50 rounded-3xl border border-gray-100 p-6 shadow-inner">
                            <div class="flex justify-between items-center mb-4 cursor-pointer select-none" @click="isHistoryOpen = !isHistoryOpen">
                                <h4 class="text-sm font-bold text-gray-700 flex items-center">
                                    <svg class="w-4 h-4 mr-2 transition-transform duration-300" :class="{'rotate-180': !isHistoryOpen}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    历史记录 ({{ history.length }})
                                </h4>
                                <button @click.stop="clearHistory" class="text-xs text-red-500 hover:text-red-600 font-medium px-3 py-1 rounded-lg hover:bg-red-50 transition-colors">
                                    清空历史
                                </button>
                            </div>
                            
                            <div v-show="isHistoryOpen">
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                                    <div v-for="(item, index) in paginatedHistory" :key="item.timestamp" class="group relative bg-white rounded-xl border border-gray-100 overflow-hidden shadow-sm hover:shadow-md hover:shadow-lg transition-all duration-300">
                                        <div class="aspect-square bg-gray-50 overflow-hidden relative">
                                            <img :src="item.url" @click="openLightbox(item.url)" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 cursor-zoom-in" loading="lazy">
                                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100 gap-2 backdrop-blur-[2px]">
                                                <button @click.stop="reusePrompt(item)" class="bg-white/90 text-gray-700 p-2 rounded-full hover:bg-blue-500 hover:text-white transition-all shadow-lg transform hover:scale-110" title="使用此提示词">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                                </button>
                                                <button @click.stop="downloadImage(item.url)" class="bg-white/90 text-gray-700 p-2 rounded-full hover:bg-green-500 hover:text-white transition-all shadow-lg transform hover:scale-110" title="下载">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                                </button>
                                                <button @click.stop="deleteHistoryItem(item)" class="bg-white/90 text-gray-700 p-2 rounded-full hover:bg-red-500 hover:text-white transition-all shadow-lg transform hover:scale-110" title="删除">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="p-3">
                                            <p class="text-xs text-gray-500 line-clamp-2" :title="item.prompt">{{ item.prompt }}</p>
                                            <p class="text-[10px] text-gray-300 mt-1">{{ new Date(item.timestamp).toLocaleString() }}</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pagination Controls -->
                                <div v-if="totalPages > 1" class="flex justify-center items-center gap-4 mt-4">
                                    <button @click="prevPage" :disabled="currentPage === 1" class="p-2 rounded-lg hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                    </button>
                                    <span class="text-xs font-medium text-gray-500">
                                        {{ currentPage }} / {{ totalPages }}
                                    </span>
                                    <button @click="nextPage" :disabled="currentPage === totalPages" class="p-2 rounded-lg hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Lightbox Modal -->
        <div v-if="isLightboxOpen" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-sm flex items-center justify-center p-4" @click="closeLightbox">
            <div class="relative max-w-full max-h-full">
                <img :src="lightboxImage" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain" @click.stop>
                <button @click="closeLightbox" class="absolute -top-12 right-0 text-white/70 hover:text-white p-2 transition-colors">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="absolute -bottom-12 left-0 right-0 flex justify-center gap-4">
                    <button @click.stop="downloadImage(lightboxImage)" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-full text-sm backdrop-blur-md transition-all flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        下载原图
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        // IndexedDB Helper for large storage
        const dbName = 'GeminiImageGenDB';
        const storeName = 'keyval';
        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, 1);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(storeName)) {
                    db.createObjectStore(storeName);
                }
            };
            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject(event.target.error);
        });

        const idbGet = async (key) => {
            try {
                const db = await dbPromise;
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('IDB Get Error:', e);
                return null;
            }
        };

        const idbSet = async (key, val) => {
            try {
                const db = await dbPromise;
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(val, key);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error('IDB Set Error:', e);
                throw e;
            }
        };

        createApp({
            setup() {
                const apiKey = ref(localStorage.getItem('gemini_api_key') || '');
                const saveButtonText = ref('保存');
                const maxHistorySize = ref(parseInt(localStorage.getItem('gemini_max_history') || '5'));
                const history = ref([]);
                const isHistoryOpen = ref(true);
                const currentPage = ref(1);
                const itemsPerPage = 6;

                const totalPages = computed(() => Math.ceil(history.value.length / itemsPerPage));
                
                const paginatedHistory = computed(() => {
                    const start = (currentPage.value - 1) * itemsPerPage;
                    const end = start + itemsPerPage;
                    return history.value.slice(start, end);
                });

                const nextPage = () => {
                    if (currentPage.value < totalPages.value) currentPage.value++;
                };

                const prevPage = () => {
                    if (currentPage.value > 1) currentPage.value--;
                };

                // Load history from IndexedDB or migrate from LocalStorage
                onMounted(async () => {
                    try {
                        // 1. Try to load from IndexedDB
                        const dbHistory = await idbGet('gemini_history');
                        if (dbHistory && Array.isArray(dbHistory)) {
                            history.value = dbHistory;
                        } else {
                            // 2. Fallback: Check LocalStorage (Migration)
                            const localHistory = localStorage.getItem('gemini_history');
                            if (localHistory) {
                                try {
                                    const parsed = JSON.parse(localHistory);
                                    if (Array.isArray(parsed)) {
                                        history.value = parsed;
                                        // Migrate to IDB
                                        await idbSet('gemini_history', JSON.parse(JSON.stringify(history.value)));
                                        // Clear LocalStorage to free up space
                                        localStorage.removeItem('gemini_history');
                                        console.log('History migrated to IndexedDB');
                                    }
                                } catch (e) {
                                    console.error('Migration failed:', e);
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Failed to load history:', e);
                    }
                });

                const saveApiKey = () => {
                    localStorage.setItem('gemini_api_key', apiKey.value);
                    saveButtonText.value = '已保存';
                    setTimeout(() => {
                        saveButtonText.value = '保存';
                    }, 2000);
                };

                const saveHistory = async () => {
                    try {
                        // Save to IndexedDB (supports large data)
                        // Clone to plain object to avoid proxy issues
                        const plainHistory = JSON.parse(JSON.stringify(history.value));
                        await idbSet('gemini_history', plainHistory);
                        
                        // Save settings to LocalStorage
                        localStorage.setItem('gemini_max_history', maxHistorySize.value.toString());
                    } catch (e) {
                        console.error('Failed to save history:', e);
                        // If IDB fails (e.g. disk full), we might want to alert user
                        if (e.name === 'QuotaExceededError') {
                            alert('存储空间不足，无法保存更多历史记录。');
                        }
                    }
                };

                const clearHistory = () => {
                    if(confirm('确定要清空所有历史记录吗？')) {
                        history.value = [];
                        currentPage.value = 1;
                        saveHistory();
                    }
                };

                const deleteHistoryItem = (itemToDelete) => {
                    const index = history.value.findIndex(item => item.timestamp === itemToDelete.timestamp);
                    if (index !== -1) {
                        history.value.splice(index, 1);
                        // Adjust page if empty
                        if (paginatedHistory.value.length === 0 && currentPage.value > 1) {
                            currentPage.value--;
                        }
                        saveHistory();
                    }
                };

                const reusePrompt = (item) => {
                    prompt.value = item.prompt;
                    // Scroll to top smoothly
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                const downloadImage = async (url, filename) => {
                    try {
                        const response = await fetch(url);
                        const blob = await response.blob();
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = filename || `generated-${Date.now()}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(link.href);
                    } catch (e) {
                        console.error('Download failed:', e);
                        window.open(url, '_blank');
                    }
                };

                const extractImage = (content) => {
                    let url = null;
                    
                    // 1. 标准 Markdown 格式: ![alt](url)
                    const mdMatch = content.match(/!\[.*?\]\((.*?)\)/);
                    if (mdMatch) {
                        url = mdMatch[1];
                    }
                    
                    // 2. HTML img 标签格式
                    if (!url) {
                        const htmlMatch = content.match(/<img.*?src=["'](.*?)["']/);
                        if (htmlMatch) {
                            url = htmlMatch[1];
                        }
                    }
                    
                    // 处理 URL：如果没有协议前缀，添加 http://
                    if (url && !url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('data:')) {
                        url = 'http://' + url;
                    }
                    
                    return url;
                };

                // 将图片URL转换为Base64格式
                const convertImageToBase64 = async (url) => {
                    // 如果已经是base64格式，直接返回
                    if (url.startsWith('data:')) {
                        return url;
                    }
                    
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const blob = await response.blob();
                        
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                    } catch (e) {
                        console.error('图片转Base64失败:', e);
                        // 如果转换失败，返回原URL
                        return url;
                    }
                };

                const selectedModel = ref('gemini-3-pro-image-preview');
                const isModelDropdownOpen = ref(false);
                const models = [
                    { value: 'gemini-3-pro-image-preview', label: 'gemini-3-pro-image-preview' },
                    { value: 'gemini-3-pro-image-preview-4k', label: 'gemini-3-pro-image-preview-4k' },
                    { value: 'gemini-2.5-flash-image', label: 'gemini-2.5-flash-image' },
                    { value: '[备选0.68￥/次]gemini-3-pro-image-preview-4k', label: '[备选0.68￥/次]gemini-3-pro-image-preview-4k' }
                ];

                const toggleModelDropdown = () => {
                    isModelDropdownOpen.value = !isModelDropdownOpen.value;
                };

                const selectModel = (modelValue) => {
                    selectedModel.value = modelValue;
                    isModelDropdownOpen.value = false;
                };

                const prompt = ref('');
                const images = ref([]);
                const loading = ref(false);
                const result = ref('');
                const error = ref('');
                const isConfigOpen = ref(false); // Mobile config toggle
                
                // Lightbox State
                const isLightboxOpen = ref(false);
                const lightboxImage = ref('');

                const openLightbox = (url) => {
                    lightboxImage.value = url;
                    isLightboxOpen.value = true;
                    document.body.style.overflow = 'hidden';
                };

                const closeLightbox = () => {
                    isLightboxOpen.value = false;
                    lightboxImage.value = '';
                    document.body.style.overflow = '';
                };

                const parsedResult = computed(() => {
                    if (!result.value) return '';
                    return marked.parse(result.value);
                });

                const handleImageUpload = (event) => {
                    const files = event.target.files;
                    if (!files || files.length === 0) return;

                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            images.value.push(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                    // Reset input so same files can be selected again if needed
                    event.target.value = '';
                };

                const removeImage = (index) => {
                    images.value.splice(index, 1);
                };

                const generate = async () => {
                    if (!apiKey.value) {
                        error.value = '请输入 API Key';
                        return;
                    }
                    if (!prompt.value) {
                        error.value = '请输入提示词';
                        return;
                    }

                    loading.value = true;
                    error.value = '';
                    result.value = '';

                    try {
                        const messages = [];
                        
                        // Prepend fixed instruction
                        const finalPrompt = "帮我生成一张图片：" + prompt.value;

                        if (images.value.length > 0) {
                            const content = [{ type: "text", text: finalPrompt }];
                            images.value.forEach(img => {
                                content.push({
                                    type: "image_url",
                                    image_url: { url: img }
                                });
                            });
                            messages.push({
                                role: "user",
                                content: content
                            });
                        } else {
                            messages.push({
                                role: "user",
                                content: finalPrompt
                            });
                        }

                        const response = await fetch('https://api.123chat.top/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey.value}`
                            },
                            body: JSON.stringify({
                                model: selectedModel.value,
                                messages: messages,
                                stream: false
                            })
                        });

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(errData.error?.message || `HTTP Error: ${response.status}`);
                        }

                        const data = await response.json();
                        if (data.choices && data.choices.length > 0) {
                            const content = data.choices[0].message.content;
                            
                            // Extract image URL
                            const imgUrl = extractImage(content);
                            if (imgUrl) {
                                // 将图片URL转换为Base64格式
                                const base64Url = await convertImageToBase64(imgUrl);
                                
                                // 更新result为base64格式的图片
                                result.value = `![generated](${base64Url})`;
                                
                                // 保存到历史记录（使用base64格式）
                                const historyItem = {
                                    url: base64Url,
                                    prompt: prompt.value,
                                    timestamp: Date.now()
                                };
                                history.value.unshift(historyItem);
                                // Limit history size
                                if (history.value.length > maxHistorySize.value) {
                                    history.value = history.value.slice(0, maxHistorySize.value);
                                }
                                saveHistory();
                            } else {
                                // 没有图片时显示原始内容
                                result.value = content;
                            }
                        } else {
                            result.value = '未收到有效回复';
                        }

                    } catch (e) {
                        console.error("Generate Error:", e);
                        if (e.message === 'Failed to fetch') {
                            error.value = '网络请求失败(CORS)。请不要直接双击打开文件，尝试使用 Live Server 或本地服务器运行。';
                        } else {
                            error.value = e.message;
                        }
                    } finally {
                        loading.value = false;
                    }
                };

                // Prompt Helper Logic
                const prompts = ref([]);
                const promptSearch = ref('');
                const promptFilter = ref('all');
                const promptsLoading = ref(false);

                const loadPrompts = async () => {
                    promptsLoading.value = true;
                    try {
                        const response = await fetch('./banana-prompt-quicker-main/prompts.json');
                        if (!response.ok) throw new Error('Failed to load local prompts');
                        prompts.value = await response.json();
                    } catch (e) {
                        console.warn('Local prompts load failed, trying GitHub fallback...', e);
                        try {
                             const response = await fetch('https://raw.githubusercontent.com/glidea/banana-prompt-quicker/main/prompts.json');
                             if(response.ok) prompts.value = await response.json();
                        } catch (e2) {
                            console.error('All prompt fetch methods failed', e2);
                        }
                    } finally {
                        // Filter out unwanted prompts
                        if (prompts.value && prompts.value.length > 0) {
                            prompts.value = prompts.value.filter(p => p.title !== '设计宣传画');
                        }
                        promptsLoading.value = false;
                    }
                };

                loadPrompts();

                const filteredPrompts = computed(() => {
                    let result = prompts.value;
                    if (promptFilter.value !== 'all') {
                        result = result.filter(p => p.mode === promptFilter.value);
                    }
                    if (promptSearch.value) {
                        const q = promptSearch.value.toLowerCase();
                        result = result.filter(p => 
                            (p.title && p.title.toLowerCase().includes(q)) || 
                            (p.prompt && p.prompt.toLowerCase().includes(q))
                        );
                    }
                    return result;
                });

                const applyPrompt = (item) => {
                    prompt.value = item.prompt;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                return {
                    apiKey,
                    saveApiKey,
                    saveButtonText,
                    maxHistorySize,
                    history,
                    clearHistory,
                    deleteHistoryItem,
                    reusePrompt,
                    downloadImage,
                    saveHistory,
                    extractImage,
                    selectedModel,
                    isModelDropdownOpen,
                    models,
                    toggleModelDropdown,
                    selectModel,
                    prompt,
                    images,
                    loading,
                    result,
                    error,
                    parsedResult,
                    handleImageUpload,
                    removeImage,
                    generate,
                    // Prompt Helper Exports
                    prompts,
                    promptSearch,
                    promptFilter,
                    promptsLoading,
                    filteredPrompts,
                    applyPrompt,
                    isConfigOpen,
                    isLightboxOpen,
                    lightboxImage,
                    openLightbox,
                    closeLightbox,
                    isHistoryOpen,
                    currentPage,
                    totalPages,
                    paginatedHistory,
                    nextPage,
                    prevPage
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
